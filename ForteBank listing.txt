Процедура Шапка()
	//ПОДГОТОВИМ ШАПКУ
	    Файл = ЭлементыФормы.ФайлЗагрузки.Значение;
		ФайлЗагр = Новый Файл(Файл);
		Если ФайлЗагр.Существует() = Ложь Тогда
			Сообщить("Файла "+Файл+" не существует!");
			//Возврат Неопределено;
		КонецЕсли;
		
		//
		//Если Кодировка = "DOS" Тогда
		//	Кодир = КодировкаТекста.OEM;
		//ИначеЕсли Кодировка = "UTF8" Тогда 
		//	Кодир = КодировкаТекста.UTF8;
		//Иначе
		//	Кодир = КодировкаТекста.ANSI;
		//КонецЕсли;
		Кодир =   КодировкаТекста.UTF8;
		ТМП = Новый ТекстовыйДокумент();
		ТМП.Прочитать(Файл,Кодир);
		
		Для й = 1 По ТМП.КоличествоСтрок() Цикл
			Стр = СокрЛП(ТМП.ПолучитьСтроку(й-1));
			Заменить = 0;
			Если Лев(Стр,18) = "ВерсияФормата=2.00" Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			Если Лев(Стр,14) = "Кодировка=UTF8" Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			Если Лев(Стр,35) = "Отправитель=Colvir Banking System 2" Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			Если Лев(Стр,84) = "Получатель=Государственное коммунальное предприятие на праве хозяйственного ведения " Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			Если Лев(Стр,13) = "ДатаСоздания=" Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			Если Лев(Стр,14) = "ВремяСоздания=" Тогда
				Стр = "";
				Заменить = 1;
			КонецЕсли;
			//Если Лев(Стр,17) = "ПлательщикБИН_ИИН" Тогда
			//	Стр = "ПлательщикРНН" + Прав(Стр,СтрДлина(Стр)-17);
			//	Заменить = 1;
			//КонецЕсли;
			Если Заменить = 1 Тогда
				ТМП.ЗаменитьСтроку(й-1,Стр);
			КонецЕсли;	
		КонецЦикла;
		
		Для й = 1 По ТМП.КоличествоСтрок() Цикл
			Стр = СокрЛП(ТМП.ПолучитьСтроку(й-1));
			Если Стр = "КонецФайла" Тогда
				Прервать;
			КонецЕсли;
			Если ПустаяСтрока(Стр) и й>1 ТОГДА //и й <> ТМП.КоличествоСтрок() Тогда
				F=F;
				ТМП.УдалитьСтроку(й-1);
				й = й - 1;
			КонецЕсли;
		КонецЦикла;
		ТМП.Записать(Файл,Кодир);
//КОНЕЦ ПОДГОТОВКИ ШАПКИ
КонецПроцедуры
Процедура УдалениеПустыхСтрок()
	Файл = ЭлементыФормы.ФайлЗагрузки.Значение;
	ФайлЗагр = Новый Файл(Файл);
	Если ФайлЗагр.Существует() = Ложь Тогда
		Сообщить("Файла "+Файл+" не существует!");
		//Возврат Неопределено;
	КонецЕсли;
		
	Кодир =   КодировкаТекста.UTF8;
	ТМП = Новый ТекстовыйДокумент();
	ТМП.Прочитать(Файл,Кодир);

	Для й = 1 По ТМП.КоличествоСтрок() Цикл
			Стр = СокрЛП(ТМП.ПолучитьСтроку(й-1));
			Если Стр = "КонецФайла" Тогда
				Прервать;
			КонецЕсли;
			Если ПустаяСтрока(Стр) и й>1 ТОГДА //и й <> ТМП.КоличествоСтрок() Тогда
				F=F;
				ТМП.УдалитьСтроку(й-1);
				й = й - 1;
			КонецЕсли;
	КонецЦикла;
	ТМП.Записать(Файл,Кодир);
	
КонецПроцедуры
Процедура КнопкаВыполнитьНажатие(Кнопка)
//ЧИТАЕМ ПЛАТЕЖКИ В МАССИВ
		Шапка();
		Файл = ЭлементыФормы.ФайлЗагрузки.Значение;
		ФайлЗагр = Новый Файл(Файл);
		Если ФайлЗагр.Существует() = Ложь Тогда
			Сообщить("Файла "+Файл+" не существует!");
			//Возврат Неопределено;
		КонецЕсли;
		Файл2 = ЭлементыФормы.ФайлЗагрузки.Значение;
		//
		//Если Кодировка = "DOS" Тогда
		//	Кодир = КодировкаТекста.OEM;
		//ИначеЕсли Кодировка = "UTF8" Тогда 
		//	Кодир = КодировкаТекста.UTF8;
		//Иначе
		//	Кодир = КодировкаТекста.ANSI;
		//КонецЕсли;
		Кодир =   КодировкаТекста.UTF8;
		ТМП   = Новый ТекстовыйДокумент();
		ТМП.Прочитать(Файл,Кодир);
		
		колвоплатежек = (ТМП.КоличествоСтрок()-14)/27;
		платежки      = Новый Массив(колвоплатежек+1, 27); //+1--0
		СчетчикСтрок  = 14;
		
		Для Счетчик = 1 По колвоплатежек Цикл //0-- -1
			Для Счетчик2 = 0 по 26 Цикл
				А=А;
				платежки[Счетчик][Счетчик2]=ТМП.ПолучитьСтроку(СчетчикСтрок);
				СчетчикСтрок = СчетчикСтрок+1;
			КонецЦикла;
		КонецЦикла;
		
		Для Счетчик = 1 По колвоплатежек Цикл //0-- -1
			//чтение нужных реквизитов
			СекцияДокумент    = платежки[Счетчик][0];
			ВидДокумента      = платежки[Счетчик][1];
			ДатаОперации	  = платежки[Счетчик][2];
			СуммаПриход       = платежки[Счетчик][3];
			СуммаРасход       = платежки[Счетчик][4];
			Если  Прав(СокрЛП(СуммаПриход),5) = "=0.00" Тогда
				Сумма = СуммаРасход;
			Иначе
				Сумма = СуммаПриход;
			КонецЕсли;
			//Сообщить(Сумма);//debug
			НомерДокумента    = платежки[Счетчик][6];
			ДатаДокумента     = платежки[Счетчик][7];
			ПлательщикНаимен  = платежки[Счетчик][8];
			ПлательщикИИН_БИН = платежки[Счетчик][9];
			ПлательщикКБЕ     = платежки[Счетчик][10];
			ПлательщикИИК     = платежки[Счетчик][11];
			ПлательщикБИК     = платежки[Счетчик][13];
			ПлательщикБИК     = СтрЗаменить(ПлательщикБИК,"БанкБИК","Бик");
			ПолучательНаимен  = платежки[Счетчик][14];
			ПолучательИИН_БИН = платежки[Счетчик][15];
			ПолучательКБЕ     = платежки[Счетчик][16];
			ПолучательИИК     = платежки[Счетчик][17];
			ПолучательБИК     = платежки[Счетчик][19];
			ПолучательБИК     = СтрЗаменить(ПолучательБИК,"БанкБИК","Бик");
			НазначениеПлатежа = платежки[Счетчик][20];
			КонецДокумента    = платежки[Счетчик][26];
			
			//запись в правильном порядке
			платежки[Счетчик][0]  = СекцияДокумент;
			платежки[Счетчик][1]  = НомерДокумента;
			платежки[Счетчик][2]  = ДатаДокумента;
			платежки[Счетчик][3]  = ВидДокумента;
			платежки[Счетчик][4]  = ПолучательНаимен;
			платежки[Счетчик][5]  = ПолучательИИН_БИН;
			платежки[Счетчик][6]  = ПолучательКБЕ;
			платежки[Счетчик][7]  = ПолучательИИК;
			платежки[Счетчик][8]  = ПолучательБИК;
			платежки[Счетчик][9]  = ПлательщикНаимен;
			платежки[Счетчик][10] = ПлательщикИИН_БИН;
			платежки[Счетчик][11] = ПлательщикКБЕ;
			платежки[Счетчик][12] = ПлательщикИИК;
			платежки[Счетчик][13] = ПлательщикБИК;
			платежки[Счетчик][14] = Сумма;
			платежки[Счетчик][15] = ДатаОперации;
			платежки[Счетчик][16] = НазначениеПлатежа;
			платежки[Счетчик][17] = КонецДокумента;
			платежки[Счетчик][18] = "";
			платежки[Счетчик][19] = "";
			платежки[Счетчик][20] = "";
			платежки[Счетчик][21] = "";
			платежки[Счетчик][22] = "";
			платежки[Счетчик][23] = "";
			платежки[Счетчик][24] = "";
			платежки[Счетчик][25] = "";
			платежки[Счетчик][26] = "";
		КонецЦикла;
		
		СчетчикСтрок  = 14;
		Для Счетчик = 1 По колвоплатежек Цикл //0-- -1
			Для Счетчик2 = 0 по 26 Цикл
				ТМП.ЗаменитьСтроку(СчетчикСтрок, платежки[Счетчик][Счетчик2]);
				СчетчикСтрок = СчетчикСтрок+1;
			КонецЦикла;
		КонецЦикла;
		ТМП.Записать(Файл2,Кодир);
		УдалениеПустыхСтрок();
	КонецПроцедуры
Процедура ФайлЗагрузкиОткрытие(Элемент, СтандартнаяОбработка)
		СтандартнаяОбработка = Ложь;
		
		ФайлНаДиске = Новый Файл(Элемент.Значение);
		Если Не ФайлНаДиске.Существует() Тогда
			Предупреждение("Не найден файл!");
			Возврат;
		КонецЕсли;
		
		Текст = Новый ТекстовыйДокумент();
		//Если Кодировка = "DOS" Тогда
		//	Кодир = КодировкаТекста.OEM;
		//ИначеЕсли Кодировка = "UTF8" Тогда 
			Кодир = КодировкаТекста.UTF8; 
		//Иначе
		//	Кодир = КодировкаТекста.ANSI;
		//КонецЕсли;
		Текст.Прочитать(Элемент.Значение, Кодир);
		Текст.Показать(Элемент.Имя,Элемент.Значение);
	КонецПроцедуры
Процедура ФайлЗагрузкиНачалоВыбора(Элемент, СтандартнаяОбработка)
		
	ДиалогФыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогФыбораФайла.Фильтр                      = "Текстовый документ(*.txt)|*.txt|XML документ(*.xml)|*.xml";
	ДиалогФыбораФайла.Заголовок                   = "Выберите файл для загрузки данных из клиента банка";
	ДиалогФыбораФайла.ПредварительныйПросмотр     = Ложь;
//	ДиалогФыбораФайла.Расширение                  = "txt";
	ДиалогФыбораФайла.Расширение                  = "";
	ДиалогФыбораФайла.ИндексФильтра               = 0;
	ДиалогФыбораФайла.ПолноеИмяФайла              = Элемент.Значение;
	ДиалогФыбораФайла.ПроверятьСуществованиеФайла = Истина;
	
	Если ДиалогФыбораФайла.Выбрать() Тогда
		Элемент.Значение = ДиалогФыбораФайла.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры

